<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CesiumJS 3D Globe Rocket Orbit Demo</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.134/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
    }
    #info {
      position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); color: #fff; padding: 8px; z-index: 10;
      font-family: sans-serif; font-size: 15px; border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="cesiumContainer"></div>
<div id="info">CesiumJS 3D Globe: Rocket Orbit Camera Demo</div>
<script>
  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4MDc5ZTc3My03NTBjLTRhNDAtODFhNy0wMmY2MmI5NmJhYmQiLCJpZCI6MjYwMTU5LCJpYXQiOjE3Mzg4NzQ0NjN9.OKY5cXo8TzgE6H_tMB84ggCprbZD91TEuBaebhl08wA';
  // Initialize Cesium Viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
    shouldAnimate: true,
    timeline: false,
    animation: false,
    baseLayerPicker: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    navigationHelpButton: false,
    infoBox: false,
    selectionIndicator: false
    });

  // Initial rocket position (Los Angeles area)
  let lat = 34.0522, lon = -118.2437, alt = 200;
  let t = 0;
  // Smoothing state
  let smoothLat = lat, smoothLon = lon, smoothAlt = alt;
  const smoothingFactor = 0.1; // 0=no smoothing, 1=full smoothing, try 0.1-0.3

  // Use a SampledPositionProperty for the path/trail
  const positionProperty = new Cesium.SampledPositionProperty();
  // Add initial position
  const startTime = Cesium.JulianDate.now();
  positionProperty.addSample(startTime, Cesium.Cartesian3.fromDegrees(lon, lat, alt));

  // Set up Cesium clock for real-time animation
  const stopTime = Cesium.JulianDate.addSeconds(startTime, 3600, new Cesium.JulianDate()); // 1 hour window
  viewer.clock.startTime = Cesium.JulianDate.clone(startTime);
  viewer.clock.stopTime = Cesium.JulianDate.clone(stopTime);
  viewer.clock.currentTime = Cesium.JulianDate.clone(startTime);
  viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;
  viewer.clock.multiplier = 1; // real time
  viewer.clock.shouldAnimate = true;

  const rocket = viewer.entities.add({
    name: 'Rocket',
    position: positionProperty,
    orientation: new Cesium.VelocityOrientationProperty(positionProperty),
    model: {
      uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb'
      // No minimumPixelSize or maximumScale: static real-world size
    },
    path: {
      show: true,
      leadTime: 0,
      trailTime: 60,
      width: 4,
      material: Cesium.Color.CYAN
    }
  });

    let animationSpeedSet = false;
    viewer.scene.postRender.addEventListener(function() {
    if (!animationSpeedSet && rocket.model && rocket.model.ready) {
        // Set all animations to 2x speed (for example)
        for (let i = 0; i < rocket.model.activeAnimations.length; i++) {
        rocket.model.activeAnimations.get(i).speedup = 0.0;
        }
        animationSpeedSet = true;
    }
    });


  // Camera: Orbit/follow the rocket with auto-zoom
  viewer.trackedEntity = rocket;
  // Set up auto-zoom: keep camera at a fixed offset (distance) from the rocket
  viewer.trackedEntityViewSettings = viewer.trackedEntityViewSettings || {};
  viewer.trackedEntityViewSettings[rocket.id] = {
    offset: new Cesium.HeadingPitchRange(
      Cesium.Math.toRadians(0),
      Cesium.Math.toRadians(-30),
      300
    )
  };
  // Do not call viewer.zoomTo(rocket); just use trackedEntity for camera following

  // Animate rocket position
  function updateRocketPosition() {
    t += 0.01; // much slower
    // Spiral trajectory for demo (smaller radius and slower)
    const r = 0.02 + 0.01 * Math.sin(t * 0.5);
    const dLat = r * Math.cos(t);
    const dLon = r * Math.sin(t);
    const targetLat = lat + dLat;
    const targetLon = lon + dLon;
    const targetAlt = alt + 200 * Math.abs(Math.sin(t * 0.3)); // less vertical speed

    // Exponential smoothing
    smoothLat = smoothingFactor * targetLat + (1 - smoothingFactor) * smoothLat;
    smoothLon = smoothingFactor * targetLon + (1 - smoothingFactor) * smoothLon;
    smoothAlt = smoothingFactor * targetAlt + (1 - smoothingFactor) * smoothAlt;

  // Add new position sample with a 1 second delay from now
  const now = Cesium.JulianDate.now();
  const delayed = Cesium.JulianDate.addSeconds(now, 0.1, new Cesium.JulianDate());
  positionProperty.addSample(delayed, Cesium.Cartesian3.fromDegrees(smoothLon, smoothLat, smoothAlt));
  }

  // Update loop
  setInterval(updateRocketPosition, 100);
</script>
</body>
</html>
